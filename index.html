<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pune Smart Metro & Campus Companion</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js for Analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- QR Code Generator (QRious) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Markdown Parser for AI Responses -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Poppins', sans-serif; background: #f3f4f6; }
        .app-container { max-width: 420px; margin: 0 auto; background: white; min-height: 100vh; position: relative; box-shadow: 0 0 20px rgba(0,0,0,0.1); }
        .glass-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 1.5rem; position: relative; overflow: hidden; }
        .glass-card::before { content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 60%); pointer-events: none; }
        .nav-item.active { color: #764ba2; font-weight: 600; }
        .hidden { display: none !important; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* SOS Button Pulse */
        .sos-btn { animation: pulse-red 2s infinite; }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }

        /* Chat Styles */
        .chat-bubble { max-width: 80%; padding: 10px 14px; border-radius: 14px; margin-bottom: 8px; font-size: 13px; line-height: 1.4; }
        .chat-user { background: #667eea; color: white; align-self: flex-end; border-bottom-right-radius: 2px; }
        .chat-ai { background: #f3f4f6; color: #333; align-self: flex-start; border-bottom-left-radius: 2px; border: 1px solid #e5e7eb; }
        .typing-dot { display: inline-block; width: 6px; height: 6px; border-radius: 50%; background: #aaa; animation: typing 1.4s infinite both; margin: 0 2px; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
    </style>
</head>
<body class="bg-gray-100">

    <!-- APP CONTAINER -->
    <div class="app-container flex flex-col">

        <!-- LOADING SCREEN -->
        <div id="loading-screen" class="fixed inset-0 z-50 bg-white flex flex-col items-center justify-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-4 border-indigo-600 mb-4"></div>
            <p class="text-sm text-gray-500 font-medium">Loading Smart Campus System...</p>
        </div>

        <!-- LOGIN VIEW -->
        <div id="login-view" class="flex-1 flex flex-col justify-center p-8 bg-white z-40 hidden">
            <div class="text-center mb-10">
                <img src="https://themetrorailguy.com//wp-content/uploads/2020/05/PuneriMetroLogo.jpg" class="h-24 mx-auto mb-4 object-contain">
                <h1 class="text-2xl font-bold text-gray-800">Smart Metro & Campus</h1>
                <p class="text-xs text-gray-500 mt-1">Emergency â€¢ Wallet â€¢ Transit</p>
            </div>
            <form id="login-form" class="space-y-4">
                <div class="relative">
                    <i class="fa-solid fa-user absolute left-4 top-3.5 text-gray-400"></i>
                    <input id="login-username" type="text" placeholder="Username (e.g. student1)" class="w-full pl-10 pr-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none transition" required>
                </div>
                <div class="relative">
                    <i class="fa-solid fa-lock absolute left-4 top-3.5 text-gray-400"></i>
                    <input id="login-password" type="password" placeholder="Password" class="w-full pl-10 pr-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none transition" required>
                </div>
                <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-3.5 rounded-xl shadow-lg hover:bg-indigo-700 transition transform active:scale-95">
                    Secure Login
                </button>
            </form>
            <p class="text-center text-xs text-gray-400 mt-8">Demo: <strong>metro123</strong></p>
        </div>

        <!-- MAIN DASHBOARD VIEW -->
        <div id="dashboard-view" class="flex-1 flex flex-col hidden relative">
            
            <!-- Header -->
            <div class="px-6 pt-12 pb-4 bg-white flex justify-between items-center">
                <div>
                    <p class="text-xs text-gray-500">Welcome Back,</p>
                    <h2 id="user-display" class="text-xl font-bold text-gray-800 capitalize">Student</h2>
                </div>
                <button onclick="logout()" class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center text-gray-600 hover:bg-red-50 hover:text-red-500 transition">
                    <i class="fa-solid fa-power-off"></i>
                </button>
            </div>

            <!-- Content Area (Scrollable) -->
            <div id="content-area" class="flex-1 overflow-y-auto pb-24 px-6 space-y-6 fade-in">
                
                <!-- Wallet Card -->
                <div class="glass-card p-6 shadow-xl">
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <p class="text-xs text-indigo-100 opacity-80">Wallet Balance</p>
                            <h1 class="text-4xl font-bold mt-1">â‚¹<span id="balance-display">0.00</span></h1>
                        </div>
                        <i class="fa-solid fa-wifi opacity-50"></i>
                    </div>
                    <div class="flex justify-between items-end mt-4">
                        <div class="text-xs bg-white/20 px-2 py-1 rounded backdrop-blur-sm">
                            Limit: â‚¹500
                        </div>
                        <span class="text-xs tracking-widest opacity-80">â€¢â€¢â€¢â€¢ 8829</span>
                    </div>
                </div>

                <!-- Quick Actions Grid -->
                <div class="grid grid-cols-4 gap-4">
                    <button onclick="openModal('topup')" class="flex flex-col items-center gap-2">
                        <div class="w-12 h-12 rounded-2xl bg-blue-50 text-blue-600 flex items-center justify-center text-lg shadow-sm active:scale-95 transition">
                            <i class="fa-solid fa-plus"></i>
                        </div>
                        <span class="text-[10px] font-medium text-gray-600">Top Up</span>
                    </button>
                    <button onclick="buyTicket()" class="flex flex-col items-center gap-2">
                        <div class="w-12 h-12 rounded-2xl bg-purple-50 text-purple-600 flex items-center justify-center text-lg shadow-sm active:scale-95 transition">
                            <i class="fa-solid fa-qrcode"></i>
                        </div>
                        <span class="text-[10px] font-medium text-gray-600">Ticket</span>
                    </button>
                    <button onclick="openModal('transfer')" class="flex flex-col items-center gap-2">
                        <div class="w-12 h-12 rounded-2xl bg-orange-50 text-orange-600 flex items-center justify-center text-lg shadow-sm active:scale-95 transition">
                            <i class="fa-solid fa-paper-plane"></i>
                        </div>
                        <span class="text-[10px] font-medium text-gray-600">Transfer</span>
                    </button>
                    <button onclick="showSection('analytics')" class="flex flex-col items-center gap-2">
                        <div class="w-12 h-12 rounded-2xl bg-green-50 text-green-600 flex items-center justify-center text-lg shadow-sm active:scale-95 transition">
                            <i class="fa-solid fa-chart-pie"></i>
                        </div>
                        <span class="text-[10px] font-medium text-gray-600">Stats</span>
                    </button>
                </div>

                <!-- Emergency SOS Section -->
                <div class="bg-red-50 border border-red-100 p-4 rounded-2xl flex items-center justify-between">
                    <div>
                        <h3 class="text-red-800 font-bold text-sm">Emergency Mode</h3>
                        <p class="text-xs text-red-600 mt-1">Press for instant help</p>
                    </div>
                    <button onclick="triggerSOS()" class="sos-btn w-12 h-12 rounded-full bg-red-600 text-white flex items-center justify-center shadow-lg active:scale-95 transition">
                        <i class="fa-solid fa-bell"></i>
                    </button>
                </div>

                <!-- Recent Transactions List -->
                <div>
                    <h3 class="text-sm font-bold text-gray-800 mb-3">Recent Activity</h3>
                    <div id="history-list" class="space-y-3">
                        <!-- JS Injected -->
                    </div>
                </div>
            </div>

            <!-- ANALYTICS SECTION -->
            <div id="analytics-area" class="hidden flex-1 overflow-y-auto pb-24 px-6 pt-4 space-y-6 fade-in bg-white">
                 <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-lg">Spending Analytics</h3>
                    <button onclick="showSection('home')" class="text-sm text-indigo-600">Back</button>
                </div>
                <div class="h-64 relative mb-6">
                    <canvas id="spendingChart"></canvas>
                </div>
                
                <!-- GEMINI AI FEATURE: Spending Insight -->
                <div class="bg-gradient-to-r from-indigo-50 to-purple-50 p-5 rounded-2xl border border-indigo-100">
                    <div class="flex items-center gap-2 mb-2">
                        <i class="fa-solid fa-sparkles text-indigo-600"></i>
                        <h4 class="font-bold text-sm text-indigo-800">AI Financial Insight</h4>
                    </div>
                    <p id="ai-insight-text" class="text-xs text-gray-600 leading-relaxed">
                        Click the button below to let Gemini AI analyze your recent spending habits and suggest improvements.
                    </p>
                    <button id="btn-analyze-spending" class="mt-3 w-full bg-white border border-indigo-200 text-indigo-600 text-xs font-bold py-2 rounded-lg shadow-sm hover:bg-indigo-50 transition flex items-center justify-center gap-2">
                        <span>âœ¨ Generate AI Report</span>
                    </button>
                </div>
            </div>

            <!-- MAP MODAL (Updated with Your Provided Image) -->
            <div id="map-modal" class="hidden absolute inset-0 bg-white z-50 flex flex-col fade-in">
                <div class="p-4 flex justify-between items-center border-b bg-white shadow-sm z-10">
                    <div>
                        <h2 class="font-bold text-lg text-gray-800">Network Map</h2>
                        <p class="text-xs text-gray-500">Purple & Aqua Lines</p>
                    </div>
                    <button onclick="closeModal('map-modal')" class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center hover:bg-gray-200"><i class="fa-solid fa-xmark"></i></button>
                </div>
                <div class="flex-1 overflow-auto bg-gray-50 flex items-center justify-center p-4">
                    <!-- Updated Map Image -->
                    <img src="https://d34vm3j4h7f97z.cloudfront.net/optimized/4X/5/6/c/56c2b0ef05b519f83d2803267910cb0f2b611c7c_2_690x450.jpeg" 
                         class="max-w-none h-full object-contain shadow-lg rounded-lg" 
                         alt="Pune Metro Map"
                         onerror="this.src='https://upload.wikimedia.org/wikipedia/commons/thumb/8/8a/Pune_Metro_Phase_1_Network_Map.jpg/1200px-Pune_Metro_Phase_1_Network_Map.jpg';">
                </div>
            </div>

            <!-- AI CHAT MODAL -->
            <div id="chat-modal" class="hidden absolute inset-0 bg-white z-50 flex flex-col fade-in">
                <!-- Chat Header -->
                <div class="p-4 bg-indigo-600 text-white flex justify-between items-center shadow-md z-10">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 bg-white/20 rounded-full flex items-center justify-center">
                            <i class="fa-solid fa-robot text-sm"></i>
                        </div>
                        <div>
                            <h2 class="font-bold text-sm">Metro Bot</h2>
                            <p class="text-[10px] opacity-80">Powered by Gemini</p>
                        </div>
                    </div>
                    <button onclick="closeModal('chat-modal')" class="text-white/80 hover:text-white"><i class="fa-solid fa-chevron-down"></i></button>
                </div>
                
                <!-- Chat Messages -->
                <div id="chat-messages" class="flex-1 overflow-y-auto p-4 bg-gray-50 flex flex-col gap-3">
                    <!-- Welcome Message -->
                    <div class="chat-bubble chat-ai">
                        Hello! I am your Smart Metro Assistant. Ask me about routes, ticket prices, or campus safety tips! ðŸš‡ðŸŽ“
                    </div>
                </div>

                <!-- Chat Input -->
                <div class="p-4 bg-white border-t border-gray-100 flex gap-2">
                    <input id="chat-input" type="text" placeholder="Ask something..." class="flex-1 bg-gray-100 border-none rounded-full px-4 py-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
                    <button onclick="sendChatMessage()" class="w-10 h-10 bg-indigo-600 text-white rounded-full flex items-center justify-center hover:bg-indigo-700 transition shadow-md">
                        <i class="fa-solid fa-paper-plane text-xs"></i>
                    </button>
                </div>
            </div>

            <!-- TICKET MODAL -->
            <div id="ticket-modal" class="hidden absolute inset-0 bg-black/80 z-50 flex items-center justify-center p-6 fade-in">
                <div class="bg-white w-full max-w-sm rounded-3xl p-6 text-center relative">
                    <button onclick="closeModal('ticket-modal')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><i class="fa-solid fa-xmark text-xl"></i></button>
                    <div class="text-green-500 text-5xl mb-4"><i class="fa-solid fa-circle-check"></i></div>
                    <h2 class="text-xl font-bold mb-1">Ticket Purchased!</h2>
                    <p class="text-xs text-gray-500 mb-6">Scan this at the metro gate</p>
                    
                    <div class="bg-white p-2 rounded-xl inline-block mb-4 border-2 border-dashed border-gray-300">
                        <canvas id="qr-code"></canvas>
                    </div>
                    
                    <div class="border-t border-dashed border-gray-300 pt-4">
                        <div class="flex justify-between text-xs mb-1">
                            <span class="text-gray-500">Amount Paid</span>
                            <span class="font-bold">â‚¹50.00</span>
                        </div>
                         <div class="flex justify-between text-xs">
                            <span class="text-gray-500">Valid For</span>
                            <span class="font-bold">2 Hours</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TRANSFER MODAL -->
            <div id="transfer-modal" class="hidden absolute inset-0 bg-black/50 z-50 flex items-end sm:items-center justify-center fade-in">
                 <div class="bg-white w-full sm:w-[90%] sm:rounded-3xl rounded-t-3xl p-6 shadow-2xl">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="font-bold text-lg">Send Money</h3>
                        <button onclick="closeModal('transfer-modal')" class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center"><i class="fa-solid fa-xmark"></i></button>
                    </div>
                    <div class="space-y-4">
                        <input id="tx-to" type="text" placeholder="Recipient Username" class="w-full p-4 bg-gray-50 rounded-xl border-none outline-none focus:ring-2 focus:ring-indigo-500">
                        <input id="tx-amount" type="number" placeholder="Amount (â‚¹)" class="w-full p-4 bg-gray-50 rounded-xl border-none outline-none focus:ring-2 focus:ring-indigo-500">
                        <button onclick="processTransfer()" class="w-full bg-indigo-600 text-white py-4 rounded-xl font-bold shadow-lg mt-2">Send Securely</button>
                    </div>
                 </div>
            </div>

            <!-- BOTTOM NAVIGATION -->
            <div class="absolute bottom-0 w-full bg-white border-t border-gray-100 px-6 py-4 flex justify-between items-center z-30">
                <button onclick="showSection('home')" class="nav-item active flex flex-col items-center gap-1 text-indigo-600">
                    <i class="fa-solid fa-house text-xl"></i>
                    <span class="text-[10px]">Home</span>
                </button>
                <button onclick="openMap()" class="nav-item flex flex-col items-center gap-1 text-gray-400 hover:text-indigo-600">
                    <i class="fa-solid fa-map-location-dot text-xl"></i>
                    <span class="text-[10px]">Map</span>
                </button>
                 <button onclick="openChat()" class="nav-item flex flex-col items-center gap-1 text-gray-400 hover:text-indigo-600">
                    <i class="fa-solid fa-wand-magic-sparkles text-xl"></i>
                    <span class="text-[10px]">AI Help</span>
                </button>
                <button onclick="showSection('analytics')" class="nav-item flex flex-col items-center gap-1 text-gray-400 hover:text-indigo-600">
                    <i class="fa-solid fa-user text-xl"></i>
                    <span class="text-[10px]">Profile</span>
                </button>
            </div>

        </div>
    </div>

    <!-- LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, onSnapshot, arrayUnion } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // GEMINI API KEY (Injected by Environment or Empty)
        const apiKey = ""; 

        // CONFIG
        const MAX_LIMIT = 500;
        const DEMO_PASSWORD = "metro123";
        
        // --- YOUR FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyDDPFexqn_F6moBX4ZLnFdZbNcKd3AO9NY",
            authDomain: "pune-metro-project.firebaseapp.com",
            projectId: "pune-metro-project",
            storageBucket: "pune-metro-project.firebasestorage.app",
            messagingSenderId: "1020604806264",
            appId: "1:1020604806264:web:3a967f188954e4047ce98d",
            measurementId: "G-6F4LNG58JF"
        };

        // GLOBALS
        let db, auth, currentUsername;
        let chartInstance = null;
        
        // --- INIT ---
        async function init() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                await signInAnonymously(auth);
                
                onAuthStateChanged(auth, u => {
                    if(u) document.getElementById('loading-screen').classList.add('hidden');
                    document.getElementById('login-view').classList.remove('hidden');
                });
            } catch(e) {
                alert("Connection Error. Ensure Firebase 'Anonymous' auth is enabled.");
            }
        }
        init();

        // --- DOM HELPERS ---
        window.openModal = (type) => {
            if(type === 'transfer') document.getElementById('transfer-modal').classList.remove('hidden');
            if(type === 'topup') processTopUp();
        };
        
        window.closeModal = (id) => document.getElementById(id).classList.add('hidden');
        window.openMap = () => document.getElementById('map-modal').classList.remove('hidden');
        window.openChat = () => document.getElementById('chat-modal').classList.remove('hidden');
        
        window.showSection = (section) => {
            const content = document.getElementById('content-area');
            const analytics = document.getElementById('analytics-area');
            
            if(section === 'analytics') {
                content.classList.add('hidden');
                analytics.classList.remove('hidden');
                renderChart();
            } else {
                content.classList.remove('hidden');
                analytics.classList.add('hidden');
            }
        }

        // --- AUTH ---
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const u = document.getElementById('login-username').value.trim().toLowerCase();
            const p = document.getElementById('login-password').value;

            if(p !== DEMO_PASSWORD) return alert("Wrong Password (Hint: metro123)");
            
            currentUsername = u;
            document.getElementById('user-display').innerText = u;
            
            document.getElementById('login-view').classList.add('hidden');
            document.getElementById('dashboard-view').classList.remove('hidden');
            
            loadData(u);
        });

        window.logout = () => window.location.reload();

        // --- DATA ---
        function getUserRef(u) {
            return doc(db, 'artifacts', 'pune-metro-project', 'public', 'data', 'wallets', u);
        }

        async function loadData(u) {
            const ref = getUserRef(u);
            const snap = await getDoc(ref);
            
            if(!snap.exists()) {
                await setDoc(ref, { balance: 0, history: [] });
            }
            
            onSnapshot(ref, (doc) => {
                const data = doc.data();
                updateUI(data.balance, data.history || []);
            });
        }

        function updateUI(bal, hist) {
            document.getElementById('balance-display').innerText = bal.toFixed(2);
            const list = document.getElementById('history-list');
            list.innerHTML = '';
            const recent = hist.slice(-5).reverse();
            
            if(recent.length === 0) list.innerHTML = '<p class="text-xs text-center text-gray-400 mt-4">No transactions yet.</p>';
            
            recent.forEach(tx => {
                const isPos = tx.amount > 0;
                const icon = getIconForDesc(tx.desc);
                list.innerHTML += `
                <div class="flex items-center justify-between bg-white p-3 rounded-xl border border-gray-50 shadow-sm">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full ${isPos?'bg-green-50 text-green-600':'bg-red-50 text-red-600'} flex items-center justify-center text-xs">
                            <i class="${icon}"></i>
                        </div>
                        <div>
                            <p class="text-xs font-bold text-gray-700">${tx.desc}</p>
                            <p class="text-[10px] text-gray-400">${new Date(tx.date).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</p>
                        </div>
                    </div>
                    <span class="text-xs font-bold ${isPos?'text-green-600':'text-red-600'}">${isPos?'+':''}â‚¹${Math.abs(tx.amount)}</span>
                </div>`;
            });
            window.latestHistory = hist; 
        }

        function getIconForDesc(desc) {
            if(desc.includes("Top-up")) return "fa-solid fa-wallet";
            if(desc.includes("Ticket")) return "fa-solid fa-train-subway";
            if(desc.includes("Sent")) return "fa-solid fa-arrow-up";
            if(desc.includes("Received")) return "fa-solid fa-arrow-down";
            if(desc.includes("SOS")) return "fa-solid fa-triangle-exclamation";
            return "fa-solid fa-circle";
        }

        // --- ACTIONS ---
        
        window.triggerSOS = async () => {
            if(!confirm("âš ï¸ ARE YOU SURE?\n\nThis will send an emergency alert with your ID.")) return;
            alert("ðŸš¨ EMERGENCY ALERT SENT!\n\nLocation: Pimpri Station (Simulated)\nAuthorities Notified.");
            const ref = getUserRef(currentUsername);
            await updateDoc(ref, { history: arrayUnion({ desc: "SOS Alert Triggered", amount: 0, date: new Date().toISOString() }) });
        };

        async function processTopUp() {
            const ref = getUserRef(currentUsername);
            const snap = await getDoc(ref);
            if(snap.data().balance + 100 > MAX_LIMIT) return alert("Wallet Limit Reached!");
            await updateDoc(ref, { balance: snap.data().balance + 100, history: arrayUnion({ desc: "Wallet Top-up", amount: 100, date: new Date().toISOString() }) });
            alert("â‚¹100 Added Successfully");
        }

        window.buyTicket = async () => {
            const ref = getUserRef(currentUsername);
            const snap = await getDoc(ref);
            if(snap.data().balance < 50) return alert("Insufficient Balance!");
            await updateDoc(ref, { balance: snap.data().balance - 50, history: arrayUnion({ desc: "Metro Ticket", amount: -50, date: new Date().toISOString() }) });
            document.getElementById('ticket-modal').classList.remove('hidden');
            const qr = new QRious({ element: document.getElementById('qr-code'), value: `TICKET-${currentUsername}-${Date.now()}`, size: 150, level: 'H' });
        };

        window.processTransfer = async () => {
            const to = document.getElementById('tx-to').value.toLowerCase().trim();
            const amt = parseFloat(document.getElementById('tx-amount').value);
            if(!to || !amt || amt <= 0 || to === currentUsername) return alert("Invalid Input");
            
            const senderRef = getUserRef(currentUsername);
            const senderSnap = await getDoc(senderRef);
            if(senderSnap.data().balance < amt) return alert("Insufficient Balance");

            await updateDoc(senderRef, { balance: senderSnap.data().balance - amt, history: arrayUnion({ desc: `Sent to ${to}`, amount: -amt, date: new Date().toISOString() }) });
            const rxRef = getUserRef(to);
            const rxSnap = await getDoc(rxRef);
            if(!rxSnap.exists()) { await setDoc(rxRef, { balance: amt, history: [{ desc: `Received from ${currentUsername}`, amount: amt, date: new Date().toISOString() }] }); } 
            else { await updateDoc(rxRef, { balance: rxSnap.data().balance + amt, history: arrayUnion({ desc: `Received from ${currentUsername}`, amount: amt, date: new Date().toISOString() }) }); }
            
            closeModal('transfer-modal');
            alert(`â‚¹${amt} Sent to ${to}!`);
        };

        window.renderChart = () => {
            const ctx = document.getElementById('spendingChart').getContext('2d');
            const data = window.latestHistory || [];
            let spent = 0, added = 0;
            data.forEach(t => t.amount < 0 ? spent += Math.abs(t.amount) : added += t.amount);
            if(chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, { type: 'doughnut', data: { labels: ['Spent', 'Added'], datasets: [{ data: [spent, added], backgroundColor: ['#ef4444', '#10b981'], borderWidth: 0 }] }, options: { responsive: true, plugins: { legend: { position: 'bottom' } } } });
        }

        // --- GEMINI LLM INTEGRATION ---

        // 1. Helper Function to Call Gemini
        async function callGeminiAPI(prompt, context = "") {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const payload = { contents: [{ parts: [{ text: context + "\n\nUser: " + prompt }] }] };
            try {
                const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || "Sorry, I couldn't process that.";
            } catch (e) {
                console.error(e);
                return "AI Service Unavailable. (Please check API Key)";
            }
        }

        // 2. AI Chat Logic
        const chatInput = document.getElementById('chat-input');
        const chatContainer = document.getElementById('chat-messages');

        window.sendChatMessage = async () => {
            const text = chatInput.value.trim();
            if(!text) return;

            // Add User Message
            chatContainer.innerHTML += `<div class="chat-bubble chat-user">${text}</div>`;
            chatInput.value = '';
            chatContainer.scrollTop = chatContainer.scrollHeight;

            // Add Loading Indicator
            const loadingId = 'loading-' + Date.now();
            chatContainer.innerHTML += `<div id="${loadingId}" class="chat-bubble chat-ai"><span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span></div>`;
            chatContainer.scrollTop = chatContainer.scrollHeight;

            // Call Gemini
            const context = "You are 'Metro Bot', a helpful AI assistant for Pune Metro commuters and university students. Keep answers short, friendly, and helpful. Assume standard Pune Metro routes (Purple/Aqua lines) and ticket price approx â‚¹10-50.";
            const reply = await callGeminiAPI(text, context);

            // Replace Loading with Reply
            document.getElementById(loadingId).remove();
            chatContainer.innerHTML += `<div class="chat-bubble chat-ai">${marked.parse(reply)}</div>`;
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // Allow "Enter" key to send
        chatInput.addEventListener('keypress', (e) => { if(e.key === 'Enter') window.sendChatMessage(); });

        // 3. Spending Analysis Logic
        document.getElementById('btn-analyze-spending').addEventListener('click', async () => {
            const btn = document.getElementById('btn-analyze-spending');
            const resultText = document.getElementById('ai-insight-text');
            
            btn.innerHTML = `<span class="animate-spin rounded-full h-4 w-4 border-b-2 border-indigo-600"></span> Analyzing...`;
            btn.disabled = true;

            const historyData = JSON.stringify(window.latestHistory || []);
            const context = "You are a financial advisor for a student. Analyze this transaction history JSON. Give 1 short, friendly, specific tip (max 25 words) about their spending or saving habits.";
            
            const insight = await callGeminiAPI(historyData, context);
            
            resultText.innerHTML = marked.parse(insight);
            resultText.classList.add('font-semibold', 'text-indigo-700');
            btn.innerHTML = `<span>âœ¨ Generate AI Report</span>`;
            btn.disabled = false;
        });

    </script>
    
    <footer class="text-center text-[10px] text-gray-400 py-4">
        Â© 2025 Smart Campus Metro | Final Year Project Prototype
    </footer>

</body>
</html>
