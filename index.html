<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pune Metro - Smart Wallet</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f0f2f5 0%, #cfd9df 100%);
        }
        .metro-gradient {
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        }
        .card-shadow {
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
        }
        .hidden { display: none; }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <!-- Loading Overlay -->
    <div id="loading-screen" class="fixed inset-0 bg-white flex flex-col items-center justify-center z-50">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mb-4"></div>
        <p class="text-gray-500 font-medium">Connecting to Pune Metro Network...</p>
    </div>

    <!-- MAIN CONTAINER -->
    <div class="w-full max-w-md bg-white rounded-3xl overflow-hidden card-shadow relative min-h-[500px]">
        
        <!-- ================= LOGIN SCREEN ================= -->
        <div id="login-view" class="p-8 flex flex-col justify-center h-full absolute inset-0 bg-white z-20">
            <div class="text-center mb-8">
                <!-- Logo -->
                <img 
                    src="https://themetrorailguy.com//wp-content/uploads/2020/05/PuneriMetroLogo.jpg" 
                    alt="Pune Metro Logo" 
                    class="mx-auto h-20 w-auto object-contain mb-4"
                    onerror="this.style.display='none'; document.getElementById('fallback-title').style.display='block';"
                >
                <h1 id="fallback-title" class="text-3xl font-bold text-gray-800 hidden">Pune Metro</h1>
                <p class="text-sm text-gray-500 font-medium">Secure Offline Wallet Login</p>
            </div>

            <form id="login-form" class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-700 uppercase tracking-wide mb-1">Username</label>
                    <input id="login-username" type="text" placeholder="e.g. student1" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 text-gray-900 focus:ring-2 focus:ring-indigo-500 outline-none transition" required>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-700 uppercase tracking-wide mb-1">Password</label>
                    <input id="login-password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 text-gray-900 focus:ring-2 focus:ring-indigo-500 outline-none transition" required>
                </div>
                
                <button type="submit" class="w-full metro-gradient text-white font-bold py-3 rounded-xl shadow-lg hover:opacity-90 transition transform active:scale-95 mt-4">
                    Secure Login
                </button>
            </form>

            <p class="text-center text-xs text-gray-400 mt-6">
                Demo Password: <strong>metro123</strong>
            </p>
        </div>

        <!-- ================= DASHBOARD SCREEN ================= -->
        <div id="dashboard-view" class="hidden h-full flex flex-col">
            
            <!-- Header -->
            <div class="p-6 text-center border-b border-gray-100 bg-gray-50/50">
                <img src="https://themetrorailguy.com//wp-content/uploads/2020/05/PuneriMetroLogo.jpg" class="h-10 mx-auto mb-2 opacity-80" onerror="this.style.display='none'">
                
                <div class="flex items-center justify-center space-x-2">
                    <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                    <p class="text-sm text-gray-600 font-medium">Welcome, <span id="user-id-display" class="font-bold text-gray-900">User</span></p>
                </div>
            </div>

            <!-- Scrollable Content -->
            <div class="flex-1 overflow-y-auto pb-20">
                <!-- Wallet Balance Card -->
                <div class="p-6">
                    <div class="metro-gradient rounded-2xl p-6 text-white shadow-lg relative overflow-hidden">
                        <div class="absolute top-0 right-0 -mr-8 -mt-8 w-32 h-32 bg-white opacity-10 rounded-full"></div>
                        <p class="text-sm opacity-90 mb-1">Total Balance</p>
                        <div class="flex items-baseline">
                            <span class="text-3xl font-bold">‚Çπ</span>
                            <span id="balance-display" class="text-5xl font-bold ml-1">0.00</span>
                        </div>
                        <p class="text-xs mt-4 opacity-75 flex justify-between">
                            <span>Limit: ‚Çπ500</span>
                            <span class="bg-white/20 px-2 py-0.5 rounded text-xs">Active</span>
                        </p>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="px-6 grid grid-cols-2 gap-4 mb-6">
                    <button id="btn-add-money" class="flex flex-col items-center justify-center p-4 rounded-xl bg-blue-50 text-blue-700 hover:bg-blue-100 transition-colors border border-blue-100 shadow-sm active:scale-95 transform">
                        <span class="text-2xl mb-1">+</span>
                        <span class="text-xs font-bold uppercase">Add ‚Çπ100</span>
                    </button>
                    <button id="btn-buy-ticket" class="flex flex-col items-center justify-center p-4 rounded-xl bg-purple-50 text-purple-700 hover:bg-purple-100 transition-colors border border-purple-100 shadow-sm active:scale-95 transform">
                        <span class="text-2xl mb-1">üéüÔ∏è</span>
                        <span class="text-xs font-bold uppercase">Ticket (‚Çπ50)</span>
                    </button>
                </div>

                <!-- Pay Someone -->
                <div class="px-6 mb-6">
                    <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Peer Transfer</h3>
                    <div class="bg-gray-50 p-4 rounded-xl border border-gray-100">
                        <div class="flex space-x-2 mb-3">
                            <input id="transfer-to" type="text" placeholder="Username (e.g. friend)" class="flex-1 bg-white border border-gray-200 rounded-lg p-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
                            <input id="transfer-amount" type="number" placeholder="‚Çπ" class="w-20 bg-white border border-gray-200 rounded-lg p-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
                        </div>
                        <button id="btn-transfer" class="w-full bg-gray-800 hover:bg-gray-900 text-white text-sm font-medium py-2 rounded-lg transition shadow-md active:scale-95">
                            Send Money
                        </button>
                    </div>
                </div>

                <!-- History -->
                <div class="px-6">
                    <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">History</h3>
                    <div id="transaction-list" class="space-y-2">
                        <!-- Items injected via JS -->
                    </div>
                </div>
            </div>

            <!-- Footer Logout -->
            <div class="p-4 bg-white border-t border-gray-100 text-center absolute bottom-0 w-full">
                <button id="btn-logout" class="text-xs text-red-500 font-bold hover:text-red-700 uppercase tracking-wide">
                    Log Out
                </button>
            </div>
        </div>
    </div>

    <!-- Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, onSnapshot, arrayUnion } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Constants
        const MAX_LIMIT = 500;
        const DEMO_PASSWORD = "metro123"; 

        // State
        let db, auth, currentUsername;
        let unsubscribeListener = null;

        // UI Refs
        const views = {
            loading: document.getElementById('loading-screen'),
            login: document.getElementById('login-view'),
            dashboard: document.getElementById('dashboard-view')
        };

        // --- Init ---
        async function initApp() {
            try {
                // --- YOUR FIREBASE CONFIGURATION (VERCEL READY) ---
                const firebaseConfig = {
                  apiKey: "AIzaSyDDPFexqn_F6moBX4ZLnFdZbNcKd3AO9NY",
                  authDomain: "pune-metro-project.firebaseapp.com",
                  projectId: "pune-metro-project",
                  storageBucket: "pune-metro-project.firebasestorage.app",
                  messagingSenderId: "1020604806264",
                  appId: "1:1020604806264:web:3a967f188954e4047ce98d",
                  measurementId: "G-6F4LNG58JF"
                };

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Use Anonymous Auth (Required: Enable in Firebase Console -> Auth -> Sign-in Method)
                await signInAnonymously(auth); 

                // Once auth is ready, hide loading and wait for user interaction
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        console.log("Connected to Firebase as:", user.uid);
                        views.loading.style.display = 'none';
                    }
                });

            } catch (err) {
                console.error("Init Error", err);
                if (err.code === 'auth/configuration-not-found' || err.code === 'auth/admin-restricted-operation') {
                    alert("DEPLOYMENT ERROR: \n\nPlease go to your Firebase Console -> Authentication -> Sign-in method -> Enable 'Anonymous' provider.");
                } else {
                    alert("Connection Error. Check console for details.");
                }
            }
        }

        // --- Login Logic ---
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('login-username').value.trim().toLowerCase();
            const password = document.getElementById('login-password').value;

            // Simple Password Check for Prototype
            if (password !== DEMO_PASSWORD) {
                alert("Incorrect Password! (Hint: metro123)");
                return;
            }

            if (username.length < 3) {
                alert("Username must be at least 3 characters.");
                return;
            }

            // Success: Switch View
            currentUsername = username;
            document.getElementById('user-id-display').textContent = username; // Display username
            
            views.login.classList.add('hidden');
            views.dashboard.classList.remove('hidden');

            // Load Data for this specific username
            loadUserData(currentUsername);
        });

        // --- Database Logic ---
        function getUserRef(username) {
            // Path: /artifacts/pune-metro-project/public/data/wallets/{username}
            // We use the projectId 'pune-metro-project' as the root to keep it organized
            return doc(db, 'artifacts', 'pune-metro-project', 'public', 'data', 'wallets', username);
        }

        async function loadUserData(username) {
            const docRef = getUserRef(username);
            
            try {
                const snap = await getDoc(docRef);

                // Create wallet if doesn't exist
                if (!snap.exists()) {
                    await setDoc(docRef, { 
                        balance: 0, 
                        history: [{ desc: "Account Opened", amount: 0, date: new Date().toISOString() }] 
                    });
                }

                // Realtime Listener
                if (unsubscribeListener) unsubscribeListener(); // Cleanup old listener
                
                unsubscribeListener = onSnapshot(docRef, (doc) => {
                    if(doc.exists()) {
                        const data = doc.data();
                        updateDashboard(data.balance, data.history || []);
                    }
                }, (error) => {
                    console.error("Listener Error:", error);
                    alert("Error syncing data. Try refreshing.");
                });
            } catch (error) {
                console.error("Load Data Error:", error);
                alert("Could not load user data. Check console. (Ensure Firestore is in Test Mode)");
            }
        }

        // --- Dashboard UI ---
        function updateDashboard(balance, history) {
            const balanceEl = document.getElementById('balance-display');
            balanceEl.textContent = balance.toFixed(2);
            
            // Visual Limit Check
            if (balance >= MAX_LIMIT) {
                balanceEl.classList.add('text-yellow-300');
            } else {
                balanceEl.classList.remove('text-yellow-300');
            }

            // History List
            const listEl = document.getElementById('transaction-list');
            listEl.innerHTML = '';
            
            const recent = history.slice(-5).reverse();
            if (recent.length === 0) listEl.innerHTML = '<p class="text-center text-xs text-gray-400 py-2">No activity yet</p>';

            recent.forEach(tx => {
                const isPos = tx.amount > 0;
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center bg-white p-2 rounded border border-gray-50';
                div.innerHTML = `
                    <span class="text-xs text-gray-600 font-medium">${tx.desc}</span>
                    <span class="text-xs font-bold ${isPos ? 'text-green-600' : 'text-red-500'}">
                        ${isPos ? '+' : ''}‚Çπ${Math.abs(tx.amount)}
                    </span>
                `;
                listEl.appendChild(div);
            });
        }

        // --- Actions ---

        // Add Money
        document.getElementById('btn-add-money').addEventListener('click', async () => {
            if (!currentUsername) return;
            const ref = getUserRef(currentUsername);
            
            try {
                const snap = await getDoc(ref);
                if (!snap.exists()) return;
                
                const current = snap.data().balance;

                if (current + 100 > MAX_LIMIT) {
                    alert(`Wallet Limit is ‚Çπ${MAX_LIMIT}`);
                    return;
                }

                await updateDoc(ref, {
                    balance: current + 100,
                    history: arrayUnion({ desc: "Top-up", amount: 100, date: new Date().toISOString() })
                });
            } catch (e) {
                console.error(e);
                alert("Transaction Failed");
            }
        });

        // Buy Ticket
        document.getElementById('btn-buy-ticket').addEventListener('click', async () => {
            if (!currentUsername) return;
            const ref = getUserRef(currentUsername);
            
            try {
                const snap = await getDoc(ref);
                const current = snap.data().balance;

                if (current < 50) {
                    alert("Insufficient Balance!");
                    return;
                }

                await updateDoc(ref, {
                    balance: current - 50,
                    history: arrayUnion({ desc: "Metro Ticket", amount: -50, date: new Date().toISOString() })
                });
            } catch (e) {
                console.error(e);
                alert("Transaction Failed");
            }
        });

        // Transfer (P2P)
        document.getElementById('btn-transfer').addEventListener('click', async () => {
            const recipient = document.getElementById('transfer-to').value.trim().toLowerCase();
            const amount = parseFloat(document.getElementById('transfer-amount').value);

            if (!recipient || amount <= 0 || isNaN(amount)) {
                alert("Invalid details");
                return;
            }
            if (recipient === currentUsername) {
                alert("Cannot send to self");
                return;
            }

            const senderRef = getUserRef(currentUsername);
            
            try {
                const senderSnap = await getDoc(senderRef);
                
                if (senderSnap.data().balance < amount) {
                    alert("Insufficient Funds");
                    return;
                }

                // 1. Deduct from Sender
                await updateDoc(senderRef, {
                    balance: senderSnap.data().balance - amount,
                    history: arrayUnion({ desc: `Sent to ${recipient}`, amount: -amount, date: new Date().toISOString() })
                });

                // 2. Add to Recipient
                const recipientRef = getUserRef(recipient);
                const recipientSnap = await getDoc(recipientRef);
                
                if (!recipientSnap.exists()) {
                     await setDoc(recipientRef, { 
                        balance: amount, 
                        history: [{ desc: `Received from ${currentUsername}`, amount: amount, date: new Date().toISOString() }] 
                    });
                } else {
                    let newBal = recipientSnap.data().balance + amount;
                    // Note: In a real app we would check recipient limit here too
                    await updateDoc(recipientRef, {
                        balance: newBal,
                        history: arrayUnion({ desc: `Received from ${currentUsername}`, amount: amount, date: new Date().toISOString() })
                    });
                }

                alert("Transfer Successful!");
                document.getElementById('transfer-to').value = '';
                document.getElementById('transfer-amount').value = '';

            } catch (e) {
                console.error(e);
                alert("Transfer Failed. Try again.");
            }
        });

        // Logout
        document.getElementById('btn-logout').addEventListener('click', () => {
            if (unsubscribeListener) unsubscribeListener();
            currentUsername = null;
            document.getElementById('login-form').reset();
            views.dashboard.classList.add('hidden');
            views.login.classList.remove('hidden');
        });

        // Start
        initApp();

    </script>
</body>
</html>